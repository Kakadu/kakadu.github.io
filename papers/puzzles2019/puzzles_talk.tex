\newif\ifanswers
%\answerstrue % comment out to hide answers
% hack from https://tex.stackexchange.com/questions/33576/conditional-typesetting-build

\documentclass[aspectratio=169
  , xcolor={svgnames}
  , hyperref={ colorlinks,citecolor=DeepPink4
             , linkcolor=DarkRed,urlcolor=DarkBlue}
  , russian
  ]{beamer}
\usetheme{CambridgeUS}
\beamertemplatenavigationsymbolsempty % remove navigation bar
\setbeamertemplate{headline}{}

\usefonttheme{professionalfonts}
\input{heading.tex}
\usepackage{tabulary}
\usepackage{verbatim}
% \usepackage{tabularx}  % for 'tabularx' environment
% \usepackage{ragged2e} % for \Centering macro
% \newcolumntype{C}{>{\Centering\arraybackslash}X}m
% sudo aptget install ttf-mscorefonts-installer
\defaultfontfeatures{Ligatures={TeX}}
\setmainfont{CMU Serif Roman}
\setsansfont{CMU Sans Serif}

\setmonofont[Scale=1.0,
    BoldFont=lmmonolt10-bold.otf,
    ItalicFont=lmmono10-italic.otf,
    BoldItalicFont=lmmonoproplt10-boldoblique.otf
]{lmmono9-regular.otf}

\newcommand{\term}[2]{\textit{#1} (#2)}

\usepackage[cache=true]{minted}
\usepackage{amsthm}

\newtheorem{remark}{\textbf{Замечание}}[section]
\newtheorem{hint}{\textbf{Указание разработчикам}}[section]

\newtheoremstyle{exerciseStyle1}
{}                % Space above
{}                % Space below
{}                % Theorem body font % (default is "\upshape")
{}                % Indent amount
{\bfseries}       % Theorem head font % (default is \mdseries)
{.}               % Punctuation after theorem head % default: no punctuation
{ }               % Space after theorem head
{}                % Theorem head spec
\theoremstyle{exerciseStyle1}
\newtheorem{exercise}{\textbf{Упражнение}}[section]


\deftranslation[to=russian]{Theorem}{Теорема}
\deftranslation[to=russian]{theorem}{теорема}

\usepackage{tikz}
\usetikzlibrary{trees}
\usepackage{subcaption}

%%%%%%%%%%%%%%%%%%
\makeatletter
\newenvironment{tabminted}{%
  \let\FV@ListVSpace\relax  
  \minted
}{%
  \endminted
  \unskip   
  \aftergroup\@tabmintedend
}
\newcommand*{\tabminted@finalstrut}[1]{%
  \ifdim\prevdepth>0pt
    \ifdim\dp#1>\prevdepth
      \vskip\dimexpr(\dp#1)-\prevdepth\relax
    \fi
  \else
    \vskip\dimexpr(\dp#1)\relax
  \fi
}
\newcommand*{\@tabmintedend}{%
  \let\@finalstrut\tabminted@finalstrut
}
\renewcommand{\cite}[1]{}
\makeatother

%\tikzset{every picture/.style={/utils/exec={\rmfamily}}}

%%%%%%%%%%%%%%%%%%%%%5
\title[]{Register Allocation by Puzzle Solving}
%\subtitle{С примерами кода на Haskell}
\author{Косарев Дмитрий }

\institute{матмех СПбГУ}

\date{\today}
 
\AtBeginSection[]
{
  \begin{frame}<beamer>%[allowframebreaks]
    \frametitle{Оглавление}
    \tableofcontents[currentsection]
  \end{frame}
}

\newcommand{\verbatimfont}[1]{\def\verbatim@font{#1}}
\setcounter{tocdepth}{1}  % part,chapters,sections 
\newcommand\chap[1]{
%  \chapter*{#1}
  \addcontentsline{toc}{chapter}{#1}
}

\usepackage{verbatimbox}

\begin{document}
\maketitle

% For every picture that defines or uses external nodes, you'll have to
% apply the 'remember picture' style. To avoid some typing, we'll apply
% the style to all pictures.
\tikzstyle{every picture}+=[remember picture] 

% By default all math in TikZ nodes are set in inline mode. Change this to
% displaystyle so that we don't get small fractions.
\everymath{\displaystyle}

% Uncomment these lines for an automatically generated outline.
\begin{frame}{Оглавление}
  \tableofcontents
\end{frame}

\begin{frame}{Распределение по регистрам (reguster allocation)}
\begin{itemize}
  \item Назначение физических локаций переменным в программе
    \begin{itemize}
      \item регистры быстрые, но их мало
      \item памяти много, но она медленная
    \end{itemize}
  \item Ограничение: переменные, которые \emph{живы одновременно}, должны быть назначены в разные регистры
  \item Если регистров не хватает, то некоторые переменные должны храниться в памяти (spilling)
\end{itemize}
\end{frame}

%{
%\setbeamertemplate{headline}{}
%\setbeamertemplate{footline}{}
%\usebackgroundtemplate{
%  \includegraphics[width=\paperwidth]{munch2.jpg}
%}
%\begin{frame}
%\end{frame}
%}

\begin{frame}{Период жизни переменной}
\noindent{
\begin{minipage}{.5\textwidth}
\begin{figure}[h]
  \input{figures/liveness.tex}\par
\end{figure}
\end{minipage}}
\begin{minipage}{.48\textwidth}
\begin{itemize}
\item Переменная \emph{живая}, если она может быть использована в будущем
\item \emph{Период жизни (live range)} переменной -- это коллекция точек программы, где она жива.
\end{itemize}
\end{minipage}

\end{frame}

\begin{frame}[fragile]{}
quiz 1?
\end{frame}

\begin{frame}[fragile]{Раскладка по регистрам и графы}
\noindent{
\begin{minipage}{.5\textwidth}
\begin{figure}[h]
  \input{figures/liveness.tex}\par
\end{figure}
\end{minipage}}
\begin{minipage}{.48\textwidth}
\begin{center}
  \begin{tikzpicture}[bullet/.style={circle, fill, inner sep=2pt}]
    \foreach \lab [count=\c 
                  ,evaluate=\c as \ang using {18+72*\c}
%                  ,evaluate=\c as \next using {mod(1+\c, 5)}
                  ] 
    in {b,c,d,e,a} {
       \node[bullet] (\c) at (\ang:10mm) {};
       \node at (\ang:14mm){$\lab$};
    }
    % it should be doable in a loop but I don't know how
    \draw (1) -- (2)  -- (3) -- (4) -- (5) --  (1);
  \end{tikzpicture}
\end{center}
SFRA = Graph Coloring. 

SRFA - NP complete
\end{minipage}

\end{frame}

\begin{frame}[fragile]{Пример}
\noindent{
\begin{minipage}{.2\textwidth}
\begin{verbatim}
a := 1

b := 2

c := a

d := b

e := c

a := d

ret a + e
\end{verbatim}
\end{minipage}}
\noindent{
\begin{minipage}{.48\textwidth}
\begin{center}
Three registers: R1, R2 и R3

\begin{tikzpicture}[bullet/.style={circle, fill, inner sep=2pt}]
  \foreach \lab [count=\c 
                ,evaluate=\c as \ang using {18+72*\c}
%                  ,evaluate=\c as \next using {mod(1+\c, 5)}
                ] 
  in {b(R2),c(R1),d(R3),e(R2),a(R1)} {
     \node[bullet] (\c) at (\ang:10mm) {};
     \node at (\ang:16mm){$\lab$};
  }
  % it should be doable in a loop but I don't know how
  \draw (1) -- (2)  -- (3) -- (4) -- (5) --  (1);
\end{tikzpicture}
\end{center}
\end{minipage}}
\begin{minipage}{.2\textwidth}
\begin{verbatim}
R1 := 1

R2 := 2

R1 := R1

R3 := R2

R2 := R1

R1 := R3

ret R1 + R2
\end{verbatim}
\end{minipage}
\end{frame}

\begin{frame}[fragile]{Live range splitting}
%\begin{figure}[h]
%  \input{figures/range-splitting.tex}
%\end{figure}
Вставка инструкций копирования для упрощения interference graph
\begin{minipage}[t]{0.48\textwidth}
  \input{figures/range-splitting.tex}
\end{minipage}
\begin{minipage}[t]{0.4\textwidth}
  \input{figures/range-splitting2.tex}
\end{minipage}
\end{frame}

\begin{frame}[fragile]{}
\begin{figure}
\centering
\includegraphics[width=0.9\paperwidth]{figures/quiz2}
%\caption{}
%\label{fig:quiz2}
\end{figure}

\end{frame}


\begin{frame}[fragile]{Static Single Assignment (SSA)}

\begin{definition}[SSA form]
``A program is defined to be in SSA form if each variable is a target of exactly one assignment statement in the program text.``
\end{definition}

Плюсы:
\begin{itemize}
\item ссылочная прозрачность (referential transparency)
\item значение переменной не зависит от позиции вхождения её идентификатора в программу
\end{itemize}
\end{frame}


\begin{frame}[fragile]{(SSA) Пример}
\noindent{
  \begin{minipage}[t]{0.48\linewidth}
  \begin{minted}[]{c}
  /* not a SSA */
  x = 1;
  y = x + 1;
  x = 2;
  z = x + 1;
  \end{minted}
\end{minipage}}
\hfill
\begin{minipage}[t]{0.48\linewidth}
  \begin{minted}[]{c}
  /* SSA */
  x1 = 1;
  y = x1 + 1;
  x2 = 2;
  z = x2 + 1;
  \end{minted}
\end{minipage}\vspace{1em}

В примере выше хочется соптимизировать и написать \mintinline{c}{z = y;} так как правые части синтаксически одинаковые.

Но это сделать нельзя так как в \mintinline{c}{x} присваивается новое значение, т.е. содержимое перемернной \mintinline{c}{z} зависит от контекста.
\end{frame}

\tikzstyle{basic block} = [rectangle, rounded corners=3mm, align=left]
\tikzstyle{large bb} = [draw, text width=3cm]
\tikzstyle{very large bb} = [draw, text width=4cm]
\tikzstyle{normal bb} = [draw, text width=2cm]

\begin{frame}[fragile]{Разветвление потока управления}
\noindent{
\begin{minipage}[t]{0.48\linewidth}
\begin{minted}[]{c}
  x = input();
  if (x==42)
  then 
    y = 1; /* A */
  else 
    y = x+2; /* B */
  end
  print(y);
\end{minted}
\end{minipage}}
\begin{minipage}[t]{0.48\linewidth}
\begin{figure}
\input{figures/ssa-phi.tikz}
\end{figure}
\end{minipage}\vspace{1em}

\end{frame}

\begin{frame}[fragile]{$\varphi$-функции}
$\varphi$-функции вставляются в точках слияния потоков управления и позволяют выбирать значение переменной

\noindent{
\begin{minipage}[t]{0.48\linewidth}
\begin{minted}[escapeinside=??]{c}
  x = input();
  if (x==42)
  then 
    ?$y_1$? = 1; /* A */
  else 
    ?$y_2$? = x+2; /* B */
  end
  ?$y_3$? = ?$\varphi(y_1,y_2);$?
  print(?$y_3$?);
\end{minted}
\end{minipage}}
\begin{minipage}[t]{0.48\linewidth}
\begin{figure}
\input{figures/ssa-phi2.tex}
\end{figure}
\end{minipage}

\end{frame}


\begin{frame}[fragile]{Static Single Information (SSI)}
По умолчанию SSA связывает некоторую информацию с парой переменная $\times$ позиция в программе.\\

Для некоторых видов анализа будет удобнее связывать иметь общую информацию по всей программе с конкретной переменной, а не каждым её вхождением. Это удобно для таких анализов:
\begin{itemize}
\item вывод классов с виртуальными методами по классам-таблицам (Python, Javascript, Ruby \& Lua)
\item Null pointer анализ
\item интервалы значений (далее будет пример)
\end{itemize}
\end{frame}



\begin{frame}[fragile]{}
\begin{figure}
\centering
\includegraphics[height=.85\textheight]{figures/dense-range-analysis}
\end{figure}
An example of a dense data-flow analysis that finds the range of possible values associated
with each variable at each program point.

\end{frame}


\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
\tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt   
\begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1]
%uncomment if require: \path (0,94.5); %set diagram left start at 0, and has height of 94.5

%Shape: Rectangle [id:dp06294366710675758] 
\draw   (99.76,20) -- (139.65,20) -- (140,40) -- (100.11,40) -- cycle ;
%Shape: Rectangle [id:dp2425421243241267] 
\draw   (20,20) -- (60,20) -- (60,60) -- (20,60) -- cycle ;
%Shape: Rectangle [id:dp944866032756623] 
\draw   (100,60) -- (139.89,60) -- (140.24,80) -- (100.35,80) -- cycle ;

% Text Node
\draw (119.88,30) node  [align=left] {X};
% Text Node
\draw (120.12,70) node  [align=left] {Z};
% Text Node
\draw (40,40) node  [align=left] {Y};


\end{tikzpicture}
\end{frame}

\begin{frame}[fragile]{Контр-пример 1}
\includegraphics[width=0.9\paperwidth]{figures/ce1.png}
Lesson: use a size-2 piece before two size-1 pieces
\end{frame}

\begin{frame}[fragile]{Контр-пример 2}
\includegraphics[width=0.9\paperwidth]{figures/ce2.png}
Lesson: statements 7-10 must come before statements 11-14
\end{frame}

\begin{frame}[fragile]{Контр-пример 3}
\includegraphics[width=0.9\paperwidth]{figures/ce3.png}
Lesson: statement 15 must come before statements 11-14
\end{frame}

\begin{frame}[fragile]{Контр-пример 4}
\includegraphics[width=0.9\paperwidth]{figures/ce4.png}
Lesson: the order in statement 11-14 is crucial
\end{frame}

\begin{frame}[fragile]
\noindent{
\begin{minipage}{.6\textwidth}
\includegraphics[height=0.9\paperheight]{figures/vis-lang.png}
\end{minipage}}
\begin{minipage}{.38\textwidth}
Визуальный язык для программирования решателей паззлов.
\end{minipage}
\end{frame}

\begin{frame}[fragile]{Индуктивные типы данных (2/2). Использование}


\begin{minipage}{.65\textwidth}
  \begin{minted}[gobble=2]{c}
  /* C */
  size_t foo(typ tag, (void*)cntnts ) {
    switch (tag) {
    case A: 
      int x    = ((a_contents*)cntnts).first;
      String s = ((a_contents*)cntnts).second;
      ...
      break;
    case B:
      ...
      break;
    }    
    assert(0); /* unreachable */
    return 0;
  }
  \end{minted}
\end{minipage}
\begin{minipage}{.3\textwidth}
  \begin{minted}[gobble=2]{haskell}
  -- Haskell
  foo (A x s) = ...
  foo B       = ...


  -- A and B are called 
  -- `constructors`
  
  
  
  
  -- compiler warns if some
  -- cases are not taken
  -- care of
  \end{minted}
\end{minipage}
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

\begin{frame}[fragile]{}
1
\end{frame}

%\input{chapter03.tex}
%
%\input{chapter05.tex}
%
%\input{chapter09.tex}


\begin{frame}
\begin{center}
  {\Huge Конец.}\\
  
  Подробнее в книге Окасаки "Чисто функциональные структуры данных".
\end{center}
\end{frame}


 \begin{frame}[allowframebreaks]
   \frametitle<presentation>{Ссылки}
   \begin{thebibliography}{10}
   \bibitem{paper}
     Register Allocation by Puzzle Solving (PLDI 2008)
     \newblock {\em Fernando Magno Quint\~ao Pereira  \& Jens Palsberg }
     \newblock \href{http://conal.net/papers/compiling-to-categories/compiling-to-categories.pdf}{PDF}
           
   \bibitem{slides1}
     Slides from Compiler Construction course of Northeastern University
     \newblock \href{https://users.cs.northwestern.edu/~robby/courses/322-2016-spring/puzzle_solving.pdf}{PDF}
   \bibitem{thesis}    
     \href{http://compilers.cs.ucla.edu/fernando/publications/papers/PhdDiss.pdf}{PhD thesis}
     \newblock {\em Fernando Magno Quint\~ao Pereira}
   \bibitem{ssabook}    
      SSA book
     \href{http://ssabook.gforge.inria.fr/latest/book.pdf}{PDF} 
%   \bibitem{}
%     \href{https://github.com/conal/concat}{Project repo}
   \end{thebibliography}
 \end{frame}

\end{document}
